{"componentChunkName":"component---src-templates-blog-post-js","path":"/javascript-event-loop-and-concurrency/","result":{"data":{"markdownRemark":{"html":"<p>Ever think about how Javascript handles incoming tasks such as function calls or event processing?</p>\n<p>In this article, we'll talk about Javascript's event loop, related concepts such as call stacks, callback queue and why they matter.</p>\n<h2>Understanding Event Loop</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 640px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/8f88fe5615a59447541157ed1a4389e6/6af66/event-loop.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 100.62500000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsSAAALEgHS3X78AAADmklEQVQ4y32US29TRxiGzz9g02U3VTf9BSwQEipVkFghoNCqUqkQF4mLQFUAESlRVaVZBDVNQQEkzCIIgkAUmxJMSSAQGgfSUNlxcKLUjhVj7Dg42I59zsy5++18c3xcGlCO9GouZ+b5LvPNKPV6Hf5Hfdd1YRgGLMuSY++/3/732bYF2zL/N0drlCbIceSkruvI5/OoVCrNha7rwRzHRblq4O2Kgbn5HGaTWSxXdJTEmBuWXKMQzCGvxCYC2bbtQRwLi/nXKL4pSG9Qd5Aq6Lg0wdH3jOPyCxMBoQvPOc5GOJ7+w+VehWzzWg16cgacqeC6sMY0VKdOozz+FSqRnajNnYMl7ExlOL4LMWy9XsM3QRW7b6nYflPFlmsqbsUNaMyA4gqgpdVQnJkD86IG5xrYiz2wnm+CNb4BWqIDlvgXf8XR+URH6wOGk0OeTgmdGOIIz5hQmQmFwq2L8OZrQK7qyAMgII/uhz3RAltA2cyPnocCeOQew56Qiv13Nal9Ql//puE2ecgFsC6AujhVypF3AHQwGlb+2ouV0c+x8ngjqtM/wHY84Pd/UNge7EAD+m1Qw52XFLIA+mVCoJKRg27pAm7g4k/bsG3zJ9jxxce4e6VVGosucLQ/4jh23wuXQj8h2qNhhsGE4YXsAQkCFHka3GLCTQPXfvkSB3d9hkO7P8XDG6ckMCaAf2ccxF45iL6jWNbFRNpCRTXe9dBthgyX4df2Fmxe/xFa1q/D7cDhhocMkXkHz9L2KtFcA0h1SMVMUNM0RD5F9bsmnvz+M86fOY4LZ44g+udVCZzKMDxNORgXgEiaWle2EWpTjUPxboAji5JE4JqqvnelKCea4eJllmE6yzEtDmgqo8k+lVO+pMs1in9H/dYS9VGtVuWY+q5o4/E4urq6EItFG1fQljJ0yr24567TNK74D4AvyqX3MHg5jUaj6O3txeDgIAqFQsM4Go+I2Rz7+5XVrwgtpJz68+l0Gv39/ZicnGzec38dGf7ga7O8vIxisSjl53O1EcaYlO+JaZrNF4n2+A4oNEgmk9KD2dlZ2aecZTIZOU4kEvIVWlpaklpcXJSh53I5LCwsyL4/Rx7LOhweHkZbWxuCwSAGBgbQ0dGBkZER9PT0oLOzE6lUSsIITJt9+TASGdA0zfNwdHQU3d3dCIfDCIVCEjQ2NoZAIIC+vj4JpA3ZbHZNUUqkh5SLUqmEcrks2w/11xKtIQY59y/mD6spCrOVhwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Event Loop\"\n        title=\"Event Loop\"\n        src=\"/static/8f88fe5615a59447541157ed1a4389e6/6af66/event-loop.png\"\n        srcset=\"/static/8f88fe5615a59447541157ed1a4389e6/69538/event-loop.png 160w,\n/static/8f88fe5615a59447541157ed1a4389e6/72799/event-loop.png 320w,\n/static/8f88fe5615a59447541157ed1a4389e6/6af66/event-loop.png 640w\"\n        sizes=\"(max-width: 640px) 100vw, 640px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>In Javascript, the event loop is a constantly running process that waits synchronously for messages to arrive (if one is not already available and waiting to be handled).</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>queue<span class=\"token punctuation\">.</span><span class=\"token function\">waitForMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    queue<span class=\"token punctuation\">.</span><span class=\"token function\">processNextMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span></code></pre></div>\n<p>Each incoming messages are then pushed into <strong>call stacks</strong>. You might already heard that Javascript is single-threaded, but what does it mean?</p>\n<p>Javascript can only do one thing at a time, because it has only one call stack.</p>\n<h3>Call Stack</h3>\n<p>A call stack is a mechanism for Javascript interpreter to keep track and manage the executions.</p>\n<p>Everytime a script calls a function, it's added to the top of the stack (because call stack operates by the principle of Last In, First Out). Everytime the function exits, it is removed from the call stack and moves on to the next function until it is empty.</p>\n<p>Take a look at the example below</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">thirdFn</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Called from thirdFn()'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">secondFn</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">thirdFn</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Called from secondFn()'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">firstFn</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">secondFn</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Called from firstFn()'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">firstFn</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Called from thirdFn()</span>\n<span class=\"token comment\">// Called from secondFn()</span>\n<span class=\"token comment\">// Called from firstFn()</span></code></pre></div>\n<p>When we run this piece of code, the <code class=\"language-text\">firstFn()</code> function will be pushed onto the call stack. And since it is at the top of the stack, it will be executed.</p>\n<p>The very first line of <code class=\"language-text\">firstFn()</code> calls <code class=\"language-text\">secondFn()</code> thus pushing the <code class=\"language-text\">secondFn()</code> to the top of the stack. The <code class=\"language-text\">secondFn()</code> then refers to another function <code class=\"language-text\">thirdFn()</code> and the process is repeated one more time.</p>\n<p>Once the stack is empty, the program will stop running.</p>\n<h3>A Single-Threaded World</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 640px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/44e3c31daa93669cb979278b663624fe/c51b0/long-thread.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 66.875%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAGQAAAgMBAAAAAAAAAAAAAAAAAAQBAgMF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAf/aAAwDAQACEAMQAAAB7GqrA1IA/8QAGhAAAgIDAAAAAAAAAAAAAAAAAQIDEQAQIf/aAAgBAQABBQIyKgvTxLIK5n//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAYEAACAwAAAAAAAAAAAAAAAAAQEQECIv/aAAgBAQAGPwLUoqx//8QAGBABAQEBAQAAAAAAAAAAAAAAAQAhUWH/2gAIAQEAAT8hKJl7aMl2Bioe2Ackv//aAAwDAQACAAMAAAAQ4D//xAAWEQADAAAAAAAAAAAAAAAAAAAQESH/2gAIAQMBAT8QiH//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/ED//xAAYEAEBAQEBAAAAAAAAAAAAAAABEQAxIf/aAAgBAQABPxBW8IK7C6AVRKZsT8agI6TBIWADevXf/9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Single Threading\"\n        title=\"Single Threading\"\n        src=\"/static/44e3c31daa93669cb979278b663624fe/c08c5/long-thread.jpg\"\n        srcset=\"/static/44e3c31daa93669cb979278b663624fe/0913d/long-thread.jpg 160w,\n/static/44e3c31daa93669cb979278b663624fe/cb69c/long-thread.jpg 320w,\n/static/44e3c31daa93669cb979278b663624fe/c08c5/long-thread.jpg 640w,\n/static/44e3c31daa93669cb979278b663624fe/6a068/long-thread.jpg 960w,\n/static/44e3c31daa93669cb979278b663624fe/eea4a/long-thread.jpg 1280w,\n/static/44e3c31daa93669cb979278b663624fe/c51b0/long-thread.jpg 5360w\"\n        sizes=\"(max-width: 640px) 100vw, 640px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>A downside of this model is that if a function takes too long to complete, no new execution contexts can happen until the function exits.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">secondFn</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Called from secondFn()'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">firstFn</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Called from firstFn()'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">var</span> i<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">&lt;</span><span class=\"token number\">1000000000</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token function\">secondFn</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">firstFn</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Called from firstFn()</span>\n<span class=\"token comment\">// 1</span>\n<span class=\"token comment\">// 2</span>\n<span class=\"token comment\">// 3</span>\n<span class=\"token comment\">// .</span>\n<span class=\"token comment\">// .</span>\n<span class=\"token comment\">// .</span>\n<span class=\"token comment\">// .</span>\n<span class=\"token comment\">// 1000000000</span>\n<span class=\"token comment\">// Called from secondFn()</span></code></pre></div>\n<p>Take a look at the example above,</p>\n<p>When we call the <code class=\"language-text\">firstFn()</code>, it will call a <code class=\"language-text\">console.log(&#39;Called from firstFn()&#39;)</code> and then wait for however long it takes to iterate through 1.000.000.000 numbers, and only then can <code class=\"language-text\">secondFn()</code> be executed.</p>\n<p>In the context of web application, no user input such as scroll or click can work during the blocking phase. Imagine using a web application where it constantly blocks you from doing basically anything, it would pretty much making it unusable.</p>\n<h2>Enter The Concurrency</h2>\n<p>While it is true that Javascript runtime can only do one thing at a time, but that's not the case with the browser. The browser itself has its own set of APIs like <code class=\"language-text\">setTimeout</code> and <code class=\"language-text\">XMLHttpRequests</code> which are not specified in the Javascript runtime.</p>\n<p>Therefore concurrency is achievable through the utilization of WebAPIs provided by the browsers.</p>\n<h3>Callback Queue</h3>\n<p>A callback queue, also referred as message queue is a waiting area for functions. Whenever the call stack is empty, the event loop will check the queue for any waiting messages. If it finds one, it will add it to the call stack, which will be executed.</p>\n<p>Let's take a look at another example</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'1st'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'2nd'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'3rd'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'4rd'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'5th'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 1st</span>\n<span class=\"token comment\">// 2nd</span>\n<span class=\"token comment\">// 5th</span>\n<span class=\"token comment\">// 3rd</span>\n<span class=\"token comment\">// 4th</span></code></pre></div>\n<p>In the code above, the execution begins by logging <code class=\"language-text\">1st</code> and <code class=\"language-text\">2nd</code>, when it reaches the third and fourth functions, it invokes <code class=\"language-text\">setTimeout</code> which is an API provided by the browser. This function accepts <code class=\"language-text\">callback</code> function as an argument which will be stored in a structure called <strong>Callback Queue</strong> for later execution. Finally, the fifth function will log <code class=\"language-text\">5th</code> as usual.</p>\n<p>So, where were third and fourth functions? They're still remained inside the callback queue waiting for the event loop to pass them back to the call stack.</p>\n<p>After the <code class=\"language-text\">5th</code> log, since there are nothing left inside the call stack, the event loop will move the third and fourth functions onto the call stack, begins the countdown (which is almost immediately, in 0 seconds) logging <code class=\"language-text\">3rd</code> and <code class=\"language-text\">4th</code> thus ending the process.</p>\n<h2>Conclusion</h2>\n<p>With this, I hope you get a better understanding of how Javascript handle incoming tasks under the hood. There are other stuffs related to event loop that I didn't cover here like Heap, <a href=\"https://javascript.info/event-loop\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">microtasks and macrotasks</a>, <a href=\"https://yonatankra.com/the-event-loop-and-your-code/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">error stacks</a> and <a href=\"https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">NodeJs event loop</a>.</p>","frontmatter":{"title":"Javascript Event Loop and Concurrency","date":"2020-11-23","shortDesc":"Understanding Event Loop, Javascripts' underlying concurrency model.","featuredImage":{"childImageSharp":{"fluid":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAPABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAIB/8QAFgEBAQEAAAAAAAAAAAAAAAAAAwAB/9oADAMBAAIQAxAAAAHVSaYpl//EABcQAQEBAQAAAAAAAAAAAAAAAAAREDH/2gAIAQEAAQUCVHN//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQAGPwJf/8QAGxAAAwEBAAMAAAAAAAAAAAAAAAERIUFhcZH/2gAIAQEAAT8h8C1Jnoh61pPnp21oWo//2gAMAwEAAgADAAAAEMPv/8QAFxEAAwEAAAAAAAAAAAAAAAAAAAERIf/aAAgBAwEBPxC4Nn//xAAVEQEBAAAAAAAAAAAAAAAAAAAQEf/aAAgBAgEBPxCH/8QAHBABAAICAwEAAAAAAAAAAAAAAREhADFBUWGx/9oACAEBAAE/EFGyENcz7iLkorTePJTcJjFBHSFzkMIh3DvCmh5dfM//2Q==","aspectRatio":1.3333333333333333,"src":"/static/3a3a7f64f4076d8a420219d38e54b05b/f422e/loops.jpg","srcSet":"/static/3a3a7f64f4076d8a420219d38e54b05b/e75b5/loops.jpg 160w,\n/static/3a3a7f64f4076d8a420219d38e54b05b/c01e2/loops.jpg 320w,\n/static/3a3a7f64f4076d8a420219d38e54b05b/f422e/loops.jpg 640w,\n/static/3a3a7f64f4076d8a420219d38e54b05b/a6352/loops.jpg 960w,\n/static/3a3a7f64f4076d8a420219d38e54b05b/ec6c5/loops.jpg 1280w,\n/static/3a3a7f64f4076d8a420219d38e54b05b/1faac/loops.jpg 3264w","sizes":"(max-width: 640px) 100vw, 640px"}}}},"timeToRead":4,"excerpt":"Ever think about how Javascript handles incoming tasks such as function calls or event processing? In this article, we'll talk about…","fields":{"slug":"/javascript-event-loop-and-concurrency/"}}},"pageContext":{"slug":"/javascript-event-loop-and-concurrency/"}}}